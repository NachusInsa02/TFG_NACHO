<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil</title>
    <link rel="stylesheet" href="../assets/perfil/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/perfil/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/perfil/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="../assets/perfil/css/styles.css">
    <style>

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 140%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            animation-name: animarEntrada;
            animation-duration: 0.4s;
        }

        .modal-contenido {
            background-color: #fefefe;
            margin: 75px auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        @keyframes animarEntrada {
            from {
                top: -300px;
                opacity: 0
            }

            to {
                top: 0;
                opacity: 1
            }
        }

        .cerrar {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .cerrar:hover,
        .cerrar:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
    </style>
</head>
<body>
    <!-- CONTENEDOR -->
    <div style="width: 100%; height: 100vh; display: flex; min-width: 375px;">
        <!-- DIV IZQUIERDA -->
        <div style="width: 75px; height: 100vh;">
            <!-- MENU LATERAL -->
            <div class="bg-body shadow d-flex flex-column flex-shrink-0 top-0 bottom-0"
                style="width: 4.5rem; height: 100vh;"><a
                    class="text-center link-body-emphasis d-block p-3 text-decoration-none border-bottom" href="#"
                    title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Icon-only"><i
                        class="fa fa-money" style="font-size: 25px;"></i><span
                        class="visually-hidden">Icon-only</span></a>
                <ul class="nav nav-pills flex-column text-center nav-flush mb-auto">
                    <li class="nav-item"><a class="nav-link active link-light py-3 border-bottom rounded-0" href="mis_tarjetas.html"
                            aria-current="page"><i class="icon-credit-card"></i></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="añadirTarjeta.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"
                                fill="none">
                                <path
                                    d="M12 4C11.4477 4 11 4.44772 11 5V11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H11V19C11 19.5523 11.4477 20 12 20C12.5523 20 13 19.5523 13 19V13H19C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11H13V5C13 4.44772 12.5523 4 12 4Z"
                                    fill="currentColor"></path>
                            </svg></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="movimientos.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor"
                                viewBox="0 0 16 16" class="bi bi-credit-card">
                                <path
                                    d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z">
                                </path>
                                <path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1z">
                                </path>
                            </svg></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="contratos.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"
                                fill="none">
                                <path d="M7 18H17V16H7V18Z" fill="currentColor"></path>
                                <path d="M17 14H7V12H17V14Z" fill="currentColor"></path>
                                <path d="M7 10H11V8H7V10Z" fill="currentColor"></path>
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M6 2C4.34315 2 3 3.34315 3 5V19C3 20.6569 4.34315 22 6 22H18C19.6569 22 21 20.6569 21 19V9C21 5.13401 17.866 2 14 2H6ZM6 4H13V9H19V19C19 19.5523 18.5523 20 18 20H6C5.44772 20 5 19.5523 5 19V5C5 4.44772 5.44772 4 6 4ZM15 4.10002C16.6113 4.4271 17.9413 5.52906 18.584 7H15V4.10002Z"
                                    fill="currentColor"></path>
                            </svg></a></li>
                </ul>
                <div class="dropdown p-3 border-top"><a
                        class="dropdown-toggle link-body-emphasis d-flex align-items-center text-decoration-none"
                        aria-expanded="false" data-bs-toggle="dropdown" role="button"><img class="rounded-circle" alt=""
                            width="32" height="32" src="https://cdn.bootstrapstudio.io/placeholders/1400x800.png"
                            style="object-fit: cover;"></a>
                    <div class="dropdown-menu shadow text-small" data-popper-placement="top-start"><a
                            class="dropdown-item" href="perfil.html">Perfil</a>
                        <div class="dropdown-divider"></div><a class="dropdown-item" id="elemento_cerrar_sesion" href="#">Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- DIV DE LA DERECHA -->
        <div
            style="flex-grow: 1; height: 100vh; display: flex; justify-content: center; align-items: center; position: relative; min-height: 600px; flex-direction: column; margin: 0 10px 0 10px;">
            <!--   TODO: IMAGEN PERFIL -->
            <div class="container mt-5">
                <div class="row">
                    <div class="col-md-4 offset-md-4">
                        <div class="profile-header-container">
                            <div style="text-align: center;" class="profile-header-img">
                                <img style="width: 175px; height: 175px; border: 1px solid gray; margin-bottom: 50px;"
                                    class="rounded-circle"
                                    src="https://cdn.bootstrapstudio.io/placeholders/1400x800.png">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h1
                style="position: absolute; top: 3%; left: 50%; transform: translate(-50%, -50%); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 3px;">
                Mi Perfil</h1>
            <form class="text-center" id="form" method="post">
                <div class="mb-3">
                    <input id="nombre" class="form-control" name="nombre" placeholder="Nombre">
                    <span id="errorNombre" style="color: red; font-size: 12px;"></span>
                    <input id="apellido" class="form-control" name="apellidos" placeholder="Apellidos"
                        style="margin-top: 10px;">
                    <span id="errorApellido" style="color: red; font-size: 12px;"></span>
                    <input id="dni" class="form-control" name="dni" placeholder="Dni" style="margin-top: 10px;">
                    <span id="errorDni" style="color: red; font-size: 12px;"></span>
                </div>
                <div class="mb-3">
                    <button class="btn btn-primary d-block w-100">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="miModal" class="modal">
        <div class="modal-contenido">
            <span class="cerrar">&times;</span>
            <p id="contenidoModal"></p>
        </div>
    </div>
    <script>

        // Verifico si la sesión está activa. Si lo está me quedo en la página, sino se te echa de la aplicación para que puedas volver a iniciar sesión.
        var formData1 = new FormData();
        var token1 = localStorage.getItem("token");
        formData1.append("token", token1);
        fetch("../php/verificar_sesion.php", {
            method: "POST",
            body: formData1
        })
        .then(response => response.json())
        .then(resultado => {
            if (resultado["status"] == "ERROR") {
                localStorage.removeItem("token");
                window.location.replace("login.html");
            } else {
                var formData2 = new FormData();
                var token2 = localStorage.getItem("token");
                formData2.append("token", token2);
                fetch("../php/recibir_datos_perfil.php", {
                    method: "POST",
                    body: formData2
                })
                .then(response => response.json())
                .then(resultado => {
                    document.getElementById("nombre").value = resultado["nombre"];
                    document.getElementById("apellido").value = resultado["apellido"];
                    document.getElementById("dni").value = resultado["dni"];
                })
            }
        });

        // Añado con DOM eventos a elementos HTML.
        const nombre = document.getElementById("nombre");
        nombre.addEventListener("keydown", prevenirEspacios);
        nombre.addEventListener("change", eliminarEspacios);
        const apellido = document.getElementById("apellido");
        apellido.addEventListener("keydown", prevenirEspacios);
        apellido.addEventListener("change", eliminarEspacios);
        const dni = document.getElementById("dni");
        dni.addEventListener("keydown", prevenirEspacios);
        dni.addEventListener("change", eliminarEspacios);

        // Evento que comprueba sesión en las páginas cacheadas y no cacheadas al querer interactuar con la aplicación.
        window.addEventListener("click", function() {

            var token6 = localStorage.getItem("token");
            var formData6 = new FormData();
            formData6.append("token", token6);
            fetch("../php/verificar_sesion.php", {
                method: "POST",
                body: formData6
            })
            .then(response => response.json())
            .then(resultado => {
                if (resultado["status"] == "ERROR") {
                    localStorage.removeItem("token");
                    window.location.replace("login.html");
                }
            });

        });

        // Añado evento "submit" al formulario para que cuando se envie se ejecute lo que hay dentro de la función.
        const form = document.getElementById("form");
        form.addEventListener("submit", function (event) {

            // Evito recarga
            event.preventDefault();
            let esValidoElFormulario = true;

            // Verifico Sesión.
            var formData3 = new FormData();
            var token3 = localStorage.getItem("token");
            formData3.append("token", token3);
            fetch("../php/verificar_sesion.php", {
                method: "POST",
                body: formData3
            })
            .then(response => response.json())
            .then(resultado => {
                if (resultado["status"] == "ERROR") {
                    localStorage.removeItem("token");
                    window.location.replace("login.html");
                } else {

                    /* VALIDO EL NOMBRE */
                    var nombre = (document.getElementById("nombre").value).trim();
                    var patron_nombre = /^[a-zA-ZÀ-ÿ\u00f1\u00d1]+(\s*[a-zA-ZÀ-ÿ\u00f1\u00d1]*)*[a-zA-ZÀ-ÿ\u00f1\u00d1]+$/g;

                    if (nombre.length < 3) {
                        document.getElementById("errorNombre").innerHTML = "El nombre es obligatorio y tiene que tener mínimo 3 caracteres";
                        esValidoElFormulario = false;
                    } else if (nombre.length > 20) {
                        document.getElementById("errorNombre").innerHTML = "El nombre es obligatorio y no puede tener más de 20 caracteres";
                        esValidoElFormulario = false;
                    } else if (patron_nombre.test(nombre) == false) {
                        document.getElementById("errorNombre").innerHTML = "El nombre solo debe contener letras";
                        esValidoElFormulario = false;
                    }
                    else {
                        document.getElementById("errorNombre").innerHTML = "";
                    }

                    /* VALIDO EL APELIDO */
                    var apellido = (document.getElementById("apellido").value).trim();
                    var patron_apellido = /^[a-zA-ZÀ-ÿ\u00f1\u00d1]+(\s*[a-zA-ZÀ-ÿ\u00f1\u00d1]*)*[a-zA-ZÀ-ÿ\u00f1\u00d1]+$/g;

                    if (apellido.length < 3) {
                        document.getElementById("errorApellido").innerHTML = "El apellido es obligatorio y tiene que tener mínimo 3 caracteres";
                        esValidoElFormulario = false;
                    } else if (apellido.length > 40) {
                        document.getElementById("errorApellido").innerHTML = "El apellido es obligatorio y no puede tener más de 40 caracteres";
                        esValidoElFormulario = false;
                    } else if (patron_apellido.test(apellido) == false) {
                        document.getElementById("errorApellido").innerHTML = "El apellido solo debe contener letras";
                        esValidoElFormulario = false;
                    }
                    else {
                        document.getElementById("errorApellido").innerHTML = "";
                    }

                    /* VALIDO EL DNI */
                    var dni = (document.getElementById("dni").value).trim();
                    var patron_dni = /^(\d{8})([A-Z])$/;

                    if (patron_dni.test(dni) == false) {
                        document.getElementById("errorDni").innerHTML = "Introduce un DNI válido(8 numeros y una letra Mayúscula)";
                        esValidoElFormulario = false;
                    } else {
                        document.getElementById("errorDni").innerHTML = "";
                    }

                    // SI TODO ES CORRECTO MANDO LOS DATOS AL PHP y BD.
                    if (esValidoElFormulario) {
                        console.log("ENVIO LA INFO A PHP SQL Y MENSAJE DE ACTUALIZADO EL PERFIL OK");
                        var formData4 = new FormData();
                        var token4 = localStorage.getItem("token");
                        formData4.append("token", token4);
                        formData4.append("nombre", nombre);
                        formData4.append("apellido", apellido);
                        formData4.append("dni", dni);
                        fetch("../php/actualizar_usuario.php", {
                            method: "POST",
                            body: formData4
                        })
                        .then(response => response.json())
                        .then(resultado => {
                            if (resultado["status"] == "OK") {
                                // Muestro Modal.
                                document.getElementById("contenidoModal").innerHTML = "Usuario Actualizado correctamente";
                                var modal = document.getElementById("miModal");
                                modal.style.display = "block";
                                var btnCerrar = document.getElementsByClassName("cerrar")[0];
                                btnCerrar.onclick = function () {
                                    modal.style.display = "none";
                                }
                                window.onclick = function (event) {
                                    if (event.target == modal) {
                                        modal.style.display = "none";
                                    }
                                }
                            } else {
                                // Muestro Modal.
                                document.getElementById("contenidoModal").innerHTML = "Error al modificar el Usuario";
                                var modal = document.getElementById("miModal");
                                modal.style.display = "block";
                                var btnCerrar = document.getElementsByClassName("cerrar")[0];
                                btnCerrar.onclick = function () {
                                    modal.style.display = "none";
                                }
                                window.onclick = function (event) {
                                    if (event.target == modal) {
                                        modal.style.display = "none";
                                    }
                                }
                            }
                        });
                    }
                }
            });

        });

        // Añadir evento "click "al elemento HTML cuyo id es "elemento_cerrar_sesion". Una vez se hace click, se ejecuta la función que modifica el estado de la sesión en la BD
        // de 0(Sesión Activa) a 1 (Sesión Caducada). Además se elimina el token del localStorage y se redirige a la pagina del Login.
        var elemento_cerrar_sesion = document.getElementById("elemento_cerrar_sesion");
        elemento_cerrar_sesion.addEventListener("click", function (event) {

            var token5 = localStorage.getItem("token");
            var formData5 = new FormData();
            formData5.append("token", token5);
            fetch("../php/cerrar_sesion.php", {
                method: "POST",
                body: formData5
            });
            localStorage.removeItem("token");
            window.location.replace("login.html");

        });

        // Función para evitar espacios.
        function prevenirEspacios(event) {
            if (event.key == ' ') {
                event.preventDefault();
            }
        }

        // Función para evitar espacios.
        function eliminarEspacios(event) {
            event.target.value = event.target.value.replace(/\s/g, '');
        }

    </script>
    <script src="../assets/perfil/bootstrap/js/bootstrap.min.js"></script>
</body>
</html>