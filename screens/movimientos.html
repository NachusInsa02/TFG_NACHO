<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos</title>
    <link rel="stylesheet" href="../assets/movimientos/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/movimientos/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/movimientos/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="../assets/movimientos/css/styles.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>

        .positivo {
            color: green !important;
        }

        .negativo {
            color: red !important;
        }

        #titulo {
            top: 2.5% !important;
        }

        /* Estilos para pantallas menores de 600px */
        @media only screen and (max-width: 599px) {
            #titulo {
            top: 4.5% !important;
        }
        }

        /* Estilos para pantallas entre 600px y 900px */
        @media only screen and (min-width: 600px) and (max-width: 899px) {
            #titulo {
                top: 3% !important;
            }
        }

        /* Estilos para pantallas mayores de 900px */
        @media only screen and (min-width: 900px) {
            #titulo {
                top: 3.5% !important;
            }
        }

    </style>
</head>
<body style="min-height: 100vh;">
    <!-- CONTENEDOR -->
    <div style="width: 100%; display: flex; min-width: 375px; min-height: 100vh;">
        <!-- DIV IZQUIERDA -->
        <div style="width: 75px; min-height: 100%;">
            <!-- MENU LATERAL -->
            <div class="bg-body shadow d-flex flex-column flex-shrink-0 top-0 bottom-0"
                style="width: 4.5rem; min-height: 100%;"><a
                    class="text-center link-body-emphasis d-block p-3 text-decoration-none border-bottom" href="#"
                    title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Icon-only"><i
                        class="fa fa-money" style="font-size: 25px;"></i><span
                        class="visually-hidden">Icon-only</span></a>
                <ul class="nav nav-pills flex-column text-center nav-flush mb-auto">
                    <li class="nav-item"><a class="nav-link active link-light py-3 border-bottom rounded-0" href="mis_tarjetas.html"
                            aria-current="page"><i class="icon-credit-card"></i></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="añadirTarjeta.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"
                                fill="none">
                                <path
                                    d="M12 4C11.4477 4 11 4.44772 11 5V11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H11V19C11 19.5523 11.4477 20 12 20C12.5523 20 13 19.5523 13 19V13H19C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11H13V5C13 4.44772 12.5523 4 12 4Z"
                                    fill="currentColor"></path>
                            </svg></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="movimientos.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor"
                                viewBox="0 0 16 16" class="bi bi-credit-card">
                                <path
                                    d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z">
                                </path>
                                <path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1z">
                                </path>
                            </svg></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="contratos.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"
                                fill="none">
                                <path d="M7 18H17V16H7V18Z" fill="currentColor"></path>
                                <path d="M17 14H7V12H17V14Z" fill="currentColor"></path>
                                <path d="M7 10H11V8H7V10Z" fill="currentColor"></path>
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M6 2C4.34315 2 3 3.34315 3 5V19C3 20.6569 4.34315 22 6 22H18C19.6569 22 21 20.6569 21 19V9C21 5.13401 17.866 2 14 2H6ZM6 4H13V9H19V19C19 19.5523 18.5523 20 18 20H6C5.44772 20 5 19.5523 5 19V5C5 4.44772 5.44772 4 6 4ZM15 4.10002C16.6113 4.4271 17.9413 5.52906 18.584 7H15V4.10002Z"
                                    fill="currentColor"></path>
                            </svg></a></li>
                </ul>
                <div class="dropdown p-3 border-top"><a
                        class="dropdown-toggle link-body-emphasis d-flex align-items-center text-decoration-none"
                        aria-expanded="false" data-bs-toggle="dropdown" role="button"><img class="rounded-circle" alt=""
                            width="32" height="32" src="https://cdn.bootstrapstudio.io/placeholders/1400x800.png"
                            style="object-fit: cover;"></a>
                    <div class="dropdown-menu shadow text-small" data-popper-placement="top-start"><a
                            class="dropdown-item" href="perfil.html">Perfil</a>
                        <div class="dropdown-divider"></div><a class="dropdown-item" id="elemento_cerrar_sesion"
                            href="#">Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- DIV DE LA DERECHA -->
        <div style="flex-grow: 1; position: relative;">
            <h1 id="titulo"
                style="position: absolute; top: 3%; left: 50%; transform: translate(-50%, -50%); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 3px;">
                Movimientos</h1>
            <div>
                <form action="">
                    <!--  <h2>Selecciona la tarjeta</h2> -->
                    <div style="max-width: 90%; margin: 120px auto 0 auto; ">
                        <label for="tarjeta" class="form-label"> Selecciona la tarjeta:</label>
                        <select class="form-select" name="tarjeta" id="tarjeta">
                            <!--  <option value="null">-------</option> -->
                            <!-- <option value="tarjeta1">xxxx xxxx xxxx 0215</option>
                            <option value="tarjeta1">xxxx xxxx xxxx 0999</option>
                            <option value="tarjeta1">xxxx xxxx xxxx 1232</option>
                            <option value="tarjeta1">xxxx xxxx xxxx 4232</option>
                            <option value="tarjeta1">xxxx xxxx xxxx 6235</option> -->
                        </select>
                        <!-- <button type="submit" class="btn btn-primary mt-2">Ver movimientos</button> -->
                    </div>
                </form>
            </div>
            <div class="table-responsive mt-5"
                style="min-width: 450px; text-align: center; max-width: 95%; max-height: 90%; margin: 0 auto;">
                <h2 id="detalleDe" class="mt-5"></h2>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Descripción</th>
                            <th>Transacción</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>

        // Verifico si la sesión está activa. Si lo está me quedo en la página, sino se te echa de la aplicación para que puedas volver a iniciar sesión.
        var formData1 = new FormData();
        var token1 = localStorage.getItem("token");
        formData1.append("token", token1);
        fetch("../php/verificar_sesion.php", {
            method: "POST",
            body: formData1
        })
        .then(response => response.json())
        .then(resultado => {
            if (resultado["status"] == "ERROR") {
                localStorage.removeItem("token");
                window.location.replace("login.html");
            } else {
                var formData2 = new FormData();
                var token2 = localStorage.getItem("token");
                formData2.append("token", token2);
                fetch("../php/tarjetas_movimientos.php", {
                    method: "POST",
                    body: formData2
                })
                .then(response => response.json())
                .then(resultado => {
                    document.getElementById("tarjeta").innerHTML = `<option value="null">------</option> `;
                    const opciones = resultado.map(tarjeta => {
                        return `<option value="${tarjeta.id}">${tarjeta.numero_tarjeta_formateada}</option>`;
                    }).join("");
                    document.getElementById("tarjeta").innerHTML += opciones;
                    console.log(resultado);
                });
            }
        });

        // Evento que comprueba sesión en las páginas cacheadas y no cacheadas al querer interactuar con la aplicación.
        window.addEventListener("click", function() {

            var token6 = localStorage.getItem("token");
            var formData6 = new FormData();
            formData6.append("token", token6);
            fetch("../php/verificar_sesion.php", {
                method: "POST",
                body: formData6
            })
            .then(response => response.json())
            .then(resultado => {
                if (resultado["status"] == "ERROR") {
                    localStorage.removeItem("token");
                    window.location.replace("login.html");
                }
            });
            
        });

        // Evento que se ejecuta cuando cambia el valor del elemento HTML al que hace referencia. Ejecuta la función descrita.
        document.getElementById("tarjeta").addEventListener("change", function (e) {

            // Verifico la sesión.
            var token5 = localStorage.getItem("token");
            var formData5 = new FormData();
            formData5.append("token", token5);
            fetch("../php/verificar_sesion.php", {
                method: "POST",
                body: formData5
            })
            .then(response => response.json())
            .then(resultado => {
                if (resultado["status"] == "ERROR") {
                    localStorage.removeItem("token");
                    window.location.replace("login.html");
                } else {
                    let select = document.getElementById("tarjeta");
                    let value = select.value;

                    if (value != "null") {
                        let valueText = select.options[select.selectedIndex].text;
                        document.getElementById("detalleDe").innerText = "Detalle de la tarjeta: " + valueText;
                    } else {
                        document.getElementById("detalleDe").innerText = "";
                    }

                    // Se conecta con la API de PHP y se muestran los movimientos en su correspondiente tabla.
                    var formData3 = new FormData();
                    var token3 = localStorage.getItem("token");
                    formData3.append("token", token3);
                    formData3.append("id_tarjeta", e.target.value);
                    fetch("../php/mostrar_movimientos.php", {
                        method: "POST",
                        body: formData3
                    })
                    .then(response => response.json())
                    .then(resultado => {
                        console.log(resultado);

                        let table = document.querySelector(".table");
                        let tbody = table.querySelector("tbody");

                        tbody.innerHTML = "";

                        resultado.forEach(function (item) {
                            console.log(item)
                            let row = document.createElement("tr");

                            let fecha = document.createElement("td");
                            fecha.textContent = item.fecha;
                            row.appendChild(fecha);

                            let descripcion = document.createElement("td");
                            descripcion.textContent = item.descripcion;
                            row.appendChild(descripcion);

                            let transaccion = document.createElement("td");
                            transaccion.textContent = item.transaccion;
                            row.appendChild(transaccion);

                            let importe = document.createElement("td");
                            importe.textContent = item.importe;
                            row.appendChild(importe);
                            tbody.appendChild(row);
                        })
                    })
                }
            });

        });

        // Añadir evento "click "al elemento HTML cuyo id es "elemento_cerrar_sesion". Una vez se hace click, se ejecuta la función que modifica el estado de la sesión en la BD
        // de 0(Sesión Activa) a 1 (Sesión Caducada). Además se elimina el token del localStorage y se redirige a la pagina del Login.
        var elemento_cerrar_sesion = document.getElementById("elemento_cerrar_sesion");
        elemento_cerrar_sesion.addEventListener("click", function (event) {

            var token4 = localStorage.getItem("token");
            var formData4 = new FormData();
            formData4.append("token", token4);
            fetch("../php/cerrar_sesion.php", {
                method: "POST",
                body: formData4
            });
            localStorage.removeItem("token");
            window.location.replace("login.html");
            
        });

    </script>
    <script src="../assets/movimientos/bootstrap/js/bootstrap.min.js"></script>
</body>
</html>