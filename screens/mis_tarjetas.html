<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Mis Tarjetas</title>
    <link rel="stylesheet" href="../assets/mis_tarjetas/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/mis_tarjetas/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/mis_tarjetas/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="../assets/mis_tarjetas/css/styles.css">
    <style>

        #titulo {
            top: 1.5%;
        }

        /* Estilos para pantallas menores de 600px */
        @media only screen and (max-width: 599px) {}

        /* Estilos para pantallas entre 600px y 900px */
        @media only screen and (min-width: 600px) and (max-width: 899px) {
            #titulo {
                top: 2%;
            }
        }

        /* Estilos para pantallas mayores de 900px */
        @media only screen and (min-width: 900px) {
            #titulo {
                top: 3%;
            }
        }
        
    </style>
</head>
<body style="min-height: 100vh;">
    <!-- CONTENEDOR -->
    <div style="width: 100%; display: flex; min-width: 375px; min-height: 100vh">

        <!-- DIV IZQUIERDA -->
        <div style="width: 75px; min-height: 100%;">

            <!-- MENU LATERAL -->
            <div class="bg-body shadow d-flex flex-column flex-shrink-0 top-0 bottom-0"
                style="width: 4.5rem; height: 100%;"><a
                    class="text-center link-body-emphasis d-block p-3 text-decoration-none border-bottom" href="#"
                    title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Icon-only"><i
                        class="fa fa-money" style="font-size: 25px;"></i><span
                        class="visually-hidden">Icon-only</span></a>
                <ul class="nav nav-pills flex-column text-center nav-flush mb-auto">
                    <li class="nav-item"><a class="nav-link active link-light py-3 border-bottom rounded-0" href="mis_tarjetas.html"
                            aria-current="page"><i class="icon-credit-card"></i></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="añadirTarjeta.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"
                                fill="none">
                                <path
                                    d="M12 4C11.4477 4 11 4.44772 11 5V11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H11V19C11 19.5523 11.4477 20 12 20C12.5523 20 13 19.5523 13 19V13H19C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11H13V5C13 4.44772 12.5523 4 12 4Z"
                                    fill="currentColor"></path>
                            </svg></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="movimientos.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor"
                                viewBox="0 0 16 16" class="bi bi-credit-card">
                                <path
                                    d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z">
                                </path>
                                <path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1z">
                                </path>
                            </svg></a></li>
                    <li class="nav-item"><a class="nav-link py-3 border-bottom rounded-0" href="contratos.html"><svg
                                xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"
                                fill="none">
                                <path d="M7 18H17V16H7V18Z" fill="currentColor"></path>
                                <path d="M17 14H7V12H17V14Z" fill="currentColor"></path>
                                <path d="M7 10H11V8H7V10Z" fill="currentColor"></path>
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M6 2C4.34315 2 3 3.34315 3 5V19C3 20.6569 4.34315 22 6 22H18C19.6569 22 21 20.6569 21 19V9C21 5.13401 17.866 2 14 2H6ZM6 4H13V9H19V19C19 19.5523 18.5523 20 18 20H6C5.44772 20 5 19.5523 5 19V5C5 4.44772 5.44772 4 6 4ZM15 4.10002C16.6113 4.4271 17.9413 5.52906 18.584 7H15V4.10002Z"
                                    fill="currentColor"></path>
                            </svg></a></li>
                </ul>
                <div class="dropdown p-3 border-top"><a
                        class="dropdown-toggle link-body-emphasis d-flex align-items-center text-decoration-none"
                        aria-expanded="false" data-bs-toggle="dropdown" role="button"><img class="rounded-circle" alt=""
                            width="32" height="32" src="https://cdn.bootstrapstudio.io/placeholders/1400x800.png"
                            style="object-fit: cover;"></a>
                    <div class="dropdown-menu shadow text-small" data-popper-placement="top-start"><a
                            class="dropdown-item" href="perfil.html">Perfil</a>
                        <div id="loquesea" class="dropdown-divider"></div><a class="dropdown-item" id="elemento_cerrar_sesion" href="#">Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- DIV DE LA DERECHA -->
        <div style="flex-grow: 1; position: relative;">
            <h1 id="titulo"
                style="position: absolute; left: 50%; transform: translate(-50%, -50%); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 3px;">
                Mis Tarjetas</h1>
            <!-- Tarjetas -->
            <div style="margin-top: 75px;">
                <div id="tarjetasContainer" class="row" style="justify-content: center; gap: 10px">
                   
                </div>
            </div>
        </div>
    </div>
    <script>

        // Verificar si la sesión al cargar la página esta activa. Dependiendo de si lo está o no te echo de la aplicación o te muestro el panel de mis tarjetas.
        var token1 = localStorage.getItem("token");
        var formData1 = new FormData();
        formData1.append("token", token1);
        fetch("../php/verificar_sesion.php", {
            method: "POST",
            body: formData1
        })
        .then(response => response.json())
        .then(resultado => {
            if (resultado["status"] == "ERROR") {
                localStorage.removeItem("token");
                window.location.replace("login.html");
            } else {
                var token2 = localStorage.getItem("token");
                var formData2 = new FormData();
                formData2.append("token", token2);
                fetch("../php/mis_tarjetas.php", {
                    method: "POST",
                    body: formData2
                })
                .then(response => response.json())
                .then(resultado => {
                    console.log(resultado);
                    mostrarTarjetas(resultado);
                })
            }
        })

        // Evento que comprueba sesión en las páginas cacheadas y no cacheadas al querer interactuar con la aplicación.
        window.addEventListener("click", function() {

            var token3 = localStorage.getItem("token");
            var formData3 = new FormData();
            formData3.append("token", token3);
            fetch("../php/verificar_sesion.php", {
                method: "POST",
                body: formData3
            })
            .then(response => response.json())
            .then(resultado => {
                if (resultado["status"] == "ERROR") {
                    localStorage.removeItem("token");
                    window.location.replace("login.html");
                }
            });

        });

        // Añadir evento "click "al elemento HTML cuyo id es "elemento_cerrar_sesion". Una vez se hace click, se ejecuta la función que modifica el estado de la sesión en la BD
        // de 0(Sesión Activa) a 1 (Sesión Caducada). Además se elimina el token del localStorage y se redirige a la pagina del Login.
        var elemento_cerrar_sesion = document.getElementById("elemento_cerrar_sesion");
        elemento_cerrar_sesion.addEventListener("click", function (event) {

            var token4 = localStorage.getItem("token");
            var formData4 = new FormData();
            formData4.append("token", token4);
            fetch("../php/cerrar_sesion.php", {
                method: "POST",
                body: formData4
            });
            localStorage.removeItem("token");
            window.location.replace("login.html");
        });

        // Función encargada de mostrar las tarjetas en su respectivo contenedor. Añade el código HTML dentro de su contenedor.
        function mostrarTarjetas(tarjetas) {

            const contenedor = document.getElementById("tarjetasContainer");
            contenedor.innerHTML = '';
            tarjetas.forEach(tarjeta => {
                contenedor.innerHTML += crearTarjetaHtml(tarjeta);
            })

        };

        // Función que genera el HTML de las tarjetas. Recibe cada tarjeta por su parámetro. Despues se accede a sus valores.
        function crearTarjetaHtml(tarjeta) {

            return `
            <div class="card" style="width: 18rem;">
                <img style="margin-top: 10px;" src="../imagenes/otras_cosas/tarjeta.jpg" alt="" class="card-img-top">
                <div class="card-body">
                    <h5 class="card-title"> Tarjeta de Débito</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${tarjeta.titular}</h6>
                    <p class="card-text">Número de la tarjeta: ${tarjeta.numero_tarjeta_formateada}</p>
                    <p class="card-text">Fecha de vencimiento: ${tarjeta.fecha_caducidad}</p>
                    <p class="card-text">CVV: ${tarjeta.cvv}</p>
                </div>
            </div> `;
            
        };

    </script>
    <script src="../assets/mis_tarjetas/bootstrap/js/bootstrap.min.js"></script>
</body>
</html>